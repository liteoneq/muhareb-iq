<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø´ÙˆØ§Ø®Øµ Ø§Ù„Ø¹Ø±Ø¨ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0f172a; --p1: #f87171; --p2: #60a5fa; --accent: #fbbf24; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        .panel { background: #1e293b; padding: 15px; border-radius: 12px; margin-bottom: 8px; width: 95%; max-width: 420px; text-align: center; border: 1px solid #334155; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { background: #0f172a; padding: 8px; border-radius: 8px; border-bottom: 4px solid #334155; transition: 0.3s; }
        .active-p1 { border-color: var(--p1) !important; box-shadow: 0 0 10px var(--p1); }
        .active-p2 { border-color: var(--p2) !important; box-shadow: 0 0 10px var(--p2); }
        #game-board { background: #1e293b; border-radius: 15px; margin: 10px 0; touch-action: none; }
        .node { cursor: pointer; stroke-width: 2; transition: 0.2s; }
        .selected { stroke: var(--accent) !important; stroke-width: 5; r: 13; }
        .menu-btn { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; background: #3b82f6; color: white; }
        .opt-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; font-size: 0.9rem; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; }
        .lvl-btn { flex: 1; padding: 6px; font-size: 0.7rem; background: #334155; border: 1px solid #475569; color: white; cursor: pointer; border-radius: 4px; }
        .lvl-active { background: var(--accent); color: black; }
        #fast-timer { color: #f43f5e; font-size: 1.4rem; font-weight: bold; }
        .hidden { display: none !important; }
        #room-tag { font-size: 0.7rem; color: #10b981; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="panel" id="main-menu">
        <h2 style="color:var(--accent)">Ø´ÙˆØ§Ø®Øµ Ø§Ù„Ø¹Ø±Ø¨</h2>
        
        <div class="opt-row">
            <input type="checkbox" id="fast-mode-toggle" checked>
            <label for="fast-mode-toggle">Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø³Ø±ÙŠØ¹ (10 Ø«ÙˆØ§Ù†Ù)</label>
        </div>

        <button class="menu-btn" onclick="initGame('pvp')">Ù„Ø¹Ø¨ Ù…Ø­Ù„ÙŠ (ØµØ¯ÙŠÙ‚ Ø¨Ø¬Ø§Ù†Ø¨Ùƒ)</button>
        
        <div style="margin-top:10px; border-top: 1px solid #334155; padding-top: 10px;">
            <button class="menu-btn" style="background:#8b5cf6" onclick="initGame('ai')">ØªØ­Ø¯ÙŠ Ø§Ù„Ø¨ÙˆØª</button>
            <div style="display:flex; gap:5px;">
                <button class="lvl-btn" id="l0" onclick="setLvl(0)">Ø³Ù‡Ù„</button>
                <button class="lvl-btn lvl-active" id="l1" onclick="setLvl(1)">Ù…ØªÙˆØ³Ø·</button>
                <button class="lvl-btn" id="l2" onclick="setLvl(2)">Ù…Ø­ØªØ±Ù</button>
            </div>
        </div>

        <div style="margin-top:10px; border-top: 1px solid #334155; padding-top: 10px;">
            <button class="menu-btn" style="background:#10b981" onclick="createOnlineRoom()">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¨Ø§Ø±Ø§Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ğŸŒ</button>
            <p id="online-msg" style="font-size:0.75rem; color:#fbbf24;"></p>
        </div>
    </div>

    <div id="game-ui" class="hidden" style="width: 100%; max-width: 420px;">
        <div class="panel">
            <div id="room-tag" class="hidden">Ù…ØªØµÙ„ Ø¨Ø§Ù„ØºØ±ÙØ©: #<span id="room-id-txt"></span></div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div id="fast-timer-box" style="color:var(--p1); font-weight:bold;">â± <span id="fast-timer">10</span></div>
                <div id="status-msg" style="color:var(--accent); font-weight:bold;">Ø§Ù†ØªØ¸Ø§Ø±...</div>
                <div>ğŸ•’ <span id="clock">00:00</span></div>
            </div>
            <div class="stats-grid" style="margin-top:10px;">
                <div id="card-p1" class="stat-card"><b>Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙˆÙ†</b><br><small>Ù…Ø®Ø²ÙˆÙ†: <span id="s1">12</span> | Ø­Ø±ÙƒØ§Øª: <span id="m1">0</span></small></div>
                <div id="card-p2" class="stat-card"><b>Ø§Ù„ÙØ±Ø³Ø§Ù†</b><br><small>Ù…Ø®Ø²ÙˆÙ†: <span id="s2">12</span> | Ø­Ø±ÙƒØ§Øª: <span id="m2">0</span></small></div>
            </div>
        </div>

        <svg id="game-board" width="360" height="360" viewBox="0 0 400 400">
            <g stroke="#475569" stroke-width="2" fill="none">
                <rect x="40" y="40" width="320" height="320"/><rect x="100" y="100" width="200" height="200"/><rect x="160" y="160" width="80" height="80"/>
                <line x1="200" y1="40" x2="200" y2="160"/><line x1="200" y1="240" x2="200" y2="360"/>
                <line x1="40" y1="200" x2="160" y2="200"/><line x1="240" y1="200" x2="360" y2="200"/>
                <line x1="40" y1="40" x2="160" y2="160"/><line x1="360" y1="40" x2="240" y2="160"/>
                <line x1="40" y1="360" x2="160" y2="240"/><line x1="360" y1="360" x2="240" y2="240"/>
            </g>
            <g id="node-layer"></g>
        </svg>

        <div style="display:flex; justify-content:space-around; width:100%; color:white; font-size:0.85rem; background:#1e293b; padding:8px; border-radius:8px;">
            <span>Ø£Ø³Ø±Ù‰ Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙŠÙ†: <b id="cap1">0</b></span>
            <span>Ø£Ø³Ø±Ù‰ Ø§Ù„ÙØ±Ø³Ø§Ù†: <b id="cap2">0</b></span>
        </div>
    </div>

    <div id="end-modal" class="hidden">
        <div class="panel" style="border: 2px solid var(--accent);">
            <h2 id="win-txt"></h2>
            <div id="final-stats" style="text-align:right; font-size:0.85rem; line-height:1.6; margin:15px 0;"></div>
            <button class="menu-btn" onclick="location.href=window.location.pathname">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
    </div>

    <script>
        // ØªÙƒÙˆÙŠÙ† Firebase (Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ©)
        const firebaseConfig = {
            apiKey: "AIzaSyDOoTFJapwZLqpauOW7fTy-REcgYbPq5dc",
            authDomain: "arabs-chess.firebaseapp.com",
            projectId: "arabs-chess",
            storageBucket: "arabs-chess.firebasestorage.app",
            messagingSenderId: "1099000738057",
            appId: "1:1099000738057:web:7c2b30c76db60b4bec23d8",
            databaseURL: "https://arabs-chess-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const nodes = [{id:0,x:40,y:40},{id:1,x:200,y:40},{id:2,x:360,y:40},{id:3,x:100,y:100},{id:4,x:200,y:100},{id:5,x:300,y:100},{id:6,x:160,y:160},{id:7,x:200,y:160},{id:8,x:240,y:160},{id:9,x:40,y:200},{id:10,x:100,y:200},{id:11,x:160,y:200},{id:12,x:240,y:200},{id:13,x:300,y:200},{id:14,x:360,y:200},{id:15,x:160,y:240},{id:16,x:200,y:240},{id:17,x:240,y:240},{id:18,x:100,y:300},{id:19,x:200,y:300},{id:20,x:300,y:300},{id:21,x:40,y:360},{id:22,x:200,y:360},{id:23,x:360,y:360}];
        const adj = {0:[1,9,3],1:[0,2,4],2:[1,14,5],3:[0,4,10,6],4:[1,3,5,7],5:[2,4,13,8],6:[3,7,11],7:[4,6,8,16],8:[5,7,12],9:[0,10,21],10:[9,3,11,18],11:[6,10,15],12:[8,13,17],13:[5,12,14,20],14:[2,13,23],15:[11,16,21],16:[15,17,19,7],17:[16,12,23],18:[10,19],19:[18,16,20,22],20:[19,13],21:[9,15,22],22:[21,19,23],23:[14,22,17]};
        const mills = [[0,1,2],[3,4,5],[6,7,8],[9,10,11],[12,13,14],[15,16,17],[18,19,20],[21,22,23],[0,9,21],[3,10,18],[6,11,15],[1,4,7],[16,19,22],[8,12,17],[5,13,20],[2,14,23],[0,3,6],[2,5,8],[21,18,15],[23,20,17]];

        let st = { board: Array(24).fill(null), turn: 'p1', phase: 'placing', p1S: 12, p2S: 12, p1A: 0, p2A: 0, m1:0, m2:0, sel: null, mode: 'pvp', active: false, time: 0, fastLeft: 10, lvl: 1, toCap: 0, isFastMode: false, roomID: null, myRole: 'spectator' };

        function setLvl(v) { st.lvl = v; [0,1,2].forEach(i => document.getElementById('l'+i).className = 'lvl-btn '+(v===i?'lvl-active':'')); }

        function createOnlineRoom() {
            const id = Math.random().toString(36).substring(7);
            st.roomID = id;
            st.myRole = 'p1';
            const link = window.location.href.split('?')[0] + '?room=' + id;
            navigator.clipboard.writeText(link);
            document.getElementById('online-msg').innerText = "ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·! Ø£Ø±Ø³Ù„Ù‡ Ù„ØµØ¯ÙŠÙ‚Ùƒ.";
            
            // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±ÙØ©
            db.ref('rooms/' + id).set({
                board: Array(24).fill(null), 
                turn: 'p1', phase: 'placing',
                p1S: 12, p2S: 12, p1A: 0, p2A: 0, m1: 0, m2: 0,
                isFastMode: document.getElementById('fast-mode-toggle').checked
            }).then(() => {
                listenToRoom(id);
                initGame('online');
            });
        }

        function listenToRoom(id) {
            db.ref('rooms/' + id).on('value', (snap) => {
                const data = snap.val();
                if(!data || !data.board) return; // Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©
                
                st.board = data.board; st.turn = data.turn; st.phase = data.phase;
                st.p1S = data.p1S; st.p2S = data.p2S; st.p1A = data.p1A; st.p2A = data.p2A;
                st.m1 = data.m1; st.m2 = data.m2; st.isFastMode = data.isFastMode;
                render();
            });
        }

        function sync() {
            if(st.mode === 'online' && st.roomID) {
                db.ref('rooms/' + st.roomID).update({
                    board: st.board, turn: st.turn, phase: st.phase,
                    p1S: st.p1S, p2S: st.p2S, p1A: st.p1A, p2A: st.p2A,
                    m1: st.m1, m2: st.m2
                });
            }
        }

        function initGame(m) {
            st.mode = m;
            st.active = true;
            st.isFastMode = (m === 'online') ? st.isFastMode : document.getElementById('fast-mode-toggle').checked;
            document.getElementById('main-menu').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            if(st.mode === 'online') {
                document.getElementById('room-tag').classList.remove('hidden');
                document.getElementById('room-id-txt').innerText = st.roomID;
            }
            if(!st.isFastMode) document.getElementById('fast-timer-box').style.display = 'none';
            setInterval(tick, 1000);
            render();
        }

        function tick() {
            if(!st.active) return;
            st.time++;
            if(st.isFastMode) {
                st.fastLeft--;
                if(st.fastLeft <= 0) {
                    if(st.mode !== 'online' || st.turn === st.myRole) autoPlay();
                }
                document.getElementById('fast-timer').innerText = st.fastLeft;
            }
            const m = Math.floor(st.time/60).toString().padStart(2,'0');
            const s = (st.time%60).toString().padStart(2,'0');
            document.getElementById('clock').innerText = `${m}:${s}`;
        }

        function autoPlay() {
            const empty = st.board.map((v,i) => v === null ? i : -1).filter(i => i !== -1);
            if(st.phase === 'placing' && empty.length > 0) {
                logic(empty[Math.floor(Math.random() * empty.length)]);
            } else if(st.phase === 'moving') {
                const myNodes = st.board.map((v,i) => v === st.turn ? i : -1).filter(i => i !== -1);
                for(let n of myNodes.sort(() => Math.random() - 0.5)) {
                    const move = adj[n].find(a => st.board[a] === null);
                    if(move !== undefined) { st.sel = n; logic(move); return; }
                }
                nextTurn();
            } else if(st.phase === 'capturing') {
                const targets = st.board.map((v,i) => (v && v !== st.turn) ? i : -1).filter(i => i !== -1);
                if(targets.length > 0) logic(targets[0]);
            }
        }

        function handle(id) {
            if(!st.active) return;
            if(st.mode === 'ai' && st.turn === 'p2') return;
            if(st.mode === 'online' && st.turn !== st.myRole) return;
            logic(id);
        }

        function logic(id) {
            st.fastLeft = 10; 
            if(st.phase === 'capturing') {
                if(st.board[id] && st.board[id] !== st.turn) {
                    st.board[id] = null;
                    if(st.turn === 'p1') st.p1A++; else st.p2A++;
                    st.toCap--;
                    if(st.toCap <= 0) { st.phase = (st.p1S+st.p2S>0)?'placing':'moving'; nextTurn(); }
                }
            } else if(st.phase === 'placing') {
                if(!st.board[id]) {
                    st.board[id] = st.turn;
                    if(st.turn === 'p1') { st.p1S--; st.m1++; } else { st.p2S--; st.m2++; }
                    checkMill(id);
                }
            } else if(st.phase === 'moving') {
                if(st.board[id] === st.turn) st.sel = id;
                else if(st.sel !== null && !st.board[id] && adj[st.sel].includes(id)) {
                    st.board[st.sel] = null; st.board[id] = st.turn;
                    if(st.turn === 'p1') st.m1++; else st.m2++;
                    st.sel = null; checkMill(id);
                }
            }
            sync(); render();
        }

        function checkMill(id) {
            let found = mills.filter(m => m.includes(id) && m.every(idx => st.board[idx] === st.turn)).length;
            if(found > 0) { st.phase = 'capturing'; st.toCap = found; sync(); } else nextTurn();
        }

        function nextTurn() {
            st.turn = st.turn === 'p1' ? 'p2' : 'p1';
            st.fastLeft = 10;
            if(st.p1S === 0 && st.p2S === 0) st.phase = 'moving';
            if(st.mode === 'ai' && st.turn === 'p2') setTimeout(() => autoPlay(), 600);
            sync(); render();
        }

        function render() {
            if(!st.board) return;
            const layer = document.getElementById('node-layer');
            layer.innerHTML = ''; let on1=0, on2=0;
            nodes.forEach(n => {
                if(st.board[n.id]==='p1') on1++; if(st.board[n.id]==='p2') on2++;
                const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                c.setAttribute("cx", n.x); c.setAttribute("cy", n.y); c.setAttribute("r", 11);
                c.setAttribute("fill", st.board[n.id]==='p1'?'var(--p1)':(st.board[n.id]==='p2'?'var(--p2)':'#1e293b'));
                c.setAttribute("stroke", "#475569");
                c.setAttribute("class", `node ${st.sel===n.id?'selected':''}`);
                c.onclick = () => handle(n.id);
                layer.appendChild(c);
            });
            document.getElementById('s1').innerText = st.p1S; document.getElementById('s2').innerText = st.p2S;
            document.getElementById('m1').innerText = st.m1; document.getElementById('m2').innerText = st.m2;
            document.getElementById('cap1').innerText = st.p1A; document.getElementById('cap2').innerText = st.p2A;
            document.getElementById('card-p1').className = `stat-card ${st.turn==='p1'?'active-p1':''}`;
            document.getElementById('card-p2').className = `stat-card ${st.turn==='p2'?'active-p2':''}`;
            document.getElementById('status-msg').innerText = st.phase==='capturing'?"Ø§Ù‚Ø¨Ø¶ Ø¹Ù„Ù‰ Ù‚Ø·Ø¹Ø©!": (st.turn==='p1'?"Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙˆÙ†":"Ø§Ù„ÙØ±Ø³Ø§Ù†");
            if(st.p1S===0 && st.p2S===0 && st.active) {
                if(on1 < 3) finish("Ø§Ù„ÙØ±Ø³Ø§Ù†"); else if(on2 < 3) finish("Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙˆÙ†");
            }
        }

        function finish(w) {
            st.active = false;
            document.getElementById('win-txt').innerText = `Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù†Ø²Ø§Ù„! Ø§Ù„ÙØ§Ø¦Ø²: ${w}`;
            document.getElementById('final-stats').innerHTML = `ğŸ“Œ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ù†ØªØµØ±: ${w}<br>âš”ï¸ Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ÙŠÙ†: ${st.m1}<br>ğŸ›¡ï¸ Ø­Ø±ÙƒØ§Øª Ø§Ù„ÙØ±Ø³Ø§Ù†: ${st.m2}<br>â° Ø§Ù„ÙˆÙ‚Øª: ${document.getElementById('clock').innerText}`;
            document.getElementById('end-modal').classList.remove('hidden');
        }

        const urlParams = new URLSearchParams(window.location.search);
        const room = urlParams.get('room');
        if(room) {
            st.roomID = room; st.myRole = 'p2';
            listenToRoom(room); initGame('online');
        }
    </script>
</body>
</html>
